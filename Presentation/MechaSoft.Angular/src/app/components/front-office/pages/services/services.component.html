<div class="services-container">
  <app-error-message [error]="error" (onClose)="error = null"></app-error-message>

  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="title">Serviços de Oficina</h1>
      <p class="subtitle">Catálogo de serviços disponíveis</p>
    </div>
    <button (click)="openCreateModal()" class="btn-primary">
      <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      Novo Serviço
    </button>
  </div>

  <!-- Services Table -->
  <div class="table-card">
    <table class="data-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Categoria</th>
          <th>Horas Estimadas</th>
          <th>Preço/Hora</th>
          <th>Preço Fixo</th>
          <th>Preço Estimado</th>
          <th>Estado</th>
          <th class="text-right">Ações</th>
        </tr>
      </thead>
      <tbody>
        @if (services.length === 0) {
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              Nenhum serviço encontrado
            </td>
          </tr>
        }
        
        @for (service of services; track service.id) {
          <tr [class.row-inactive]="!service.isActive">
            <td class="font-medium">{{ service.name }}</td>
            <td>
              <span class="badge badge-blue">{{ service.category }}</span>
            </td>
            <td>{{ service.estimatedHours }}h</td>
            <td>{{ service.pricePerHour ? formatCurrency(service.pricePerHour) : '-' }}</td>
            <td>{{ service.fixedPrice ? formatCurrency(service.fixedPrice) : '-' }}</td>
            <td class="font-bold text-green-600">{{ formatCurrency(calculateEstimatedPrice(service)) }}</td>
            <td>
              <span [class]="service.isActive ? 'badge badge-green' : 'badge badge-gray'">
                {{ service.isActive ? 'Ativo' : 'Inativo' }}
              </span>
              @if (service.requiresInspection) {
                <span class="badge badge-yellow ml-1">Requer Inspeção</span>
              }
            </td>
            <td class="text-right">
              <button (click)="openEditModal(service)" class="btn-icon btn-edit" title="Editar">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>

    <!-- Pagination -->
    @if (totalPages > 1) {
      <div class="pagination">
        <button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1" class="btn-pagination">
          Anterior
        </button>
        <span class="pagination-info">
          Página {{ currentPage }} de {{ totalPages }} ({{ totalCount }} serviços)
        </span>
        <button (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages" class="btn-pagination">
          Próxima
        </button>
      </div>
    }
  </div>

  <!-- Modal Create/Edit -->
  @if (showModal) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">{{ isEditMode ? 'Editar Serviço' : 'Novo Serviço' }}</h2>
          <button (click)="closeModal()" class="btn-close">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <form [formGroup]="serviceForm" (ngSubmit)="onSubmit()" class="modal-body">
          <div class="form-section">
            <h3 class="form-section-title">Informações do Serviço</h3>
            
            <div class="form-group">
              <label class="form-label">Nome do Serviço *</label>
              <input type="text" formControlName="name" placeholder="Troca de óleo" class="form-input" [class.input-error]="isFieldInvalid('name')" />
              @if (isFieldInvalid('name')) {
                <span class="error-text">{{ getFieldError('name') }}</span>
              }
            </div>

            <div class="form-group">
              <label class="form-label">Descrição *</label>
              <textarea formControlName="description" rows="3" placeholder="Descreva o serviço..." class="form-input" [class.input-error]="isFieldInvalid('description')"></textarea>
              @if (isFieldInvalid('description')) {
                <span class="error-text">{{ getFieldError('description') }}</span>
              }
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Categoria *</label>
                <select formControlName="category" class="form-input" [class.input-error]="isFieldInvalid('category')">
                  <option value="">Selecione</option>
                  @for (cat of categories; track cat) {
                    <option [value]="cat">{{ cat }}</option>
                  }
                </select>
                @if (isFieldInvalid('category')) {
                  <span class="error-text">{{ getFieldError('category') }}</span>
                }
              </div>
              
              <div class="form-group">
                <label class="form-label">Horas Estimadas *</label>
                <input type="number" formControlName="estimatedHours" step="0.5" class="form-input" [class.input-error]="isFieldInvalid('estimatedHours')" />
                @if (isFieldInvalid('estimatedHours')) {
                  <span class="error-text">{{ getFieldError('estimatedHours') }}</span>
                }
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Preço por Hora (€)</label>
                <input type="number" formControlName="pricePerHour" step="0.01" placeholder="45.00" class="form-input" />
              </div>
              
              <div class="form-group">
                <label class="form-label">Preço Fixo (€)</label>
                <input type="number" formControlName="fixedPrice" step="0.01" placeholder="150.00" class="form-input" />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label flex items-center gap-2">
                <input type="checkbox" formControlName="requiresInspection" class="form-checkbox" />
                <span>Requer Inspeção</span>
              </label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" (click)="closeModal()" class="btn-secondary">Cancelar</button>
            <button type="submit" [disabled]="serviceForm.invalid" class="btn-primary">
              {{ isEditMode ? 'Guardar' : 'Criar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
